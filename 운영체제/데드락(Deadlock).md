# 데드락(Deadlock, 교착 상태)

데드락(교착상태)이란, 둘 이상의 프로세스가 다른 프로세스가 점유하고 있는 자원을 서로 기다릴 때 무한 대기에 빠지는 상황을 일컫는다.

</br>

### 데드락(Dead lock)의 발생 조건

교착 상태는 한 시스템 내에서 다음 네 가지 조건이 동시에 성립할 때 발생한다. 네 가지 조건 중 하나라도 성립하지 않으면 교착 상태는 발생하지 않는다.

|                                 |                                                              |
| ------------------------------- | ------------------------------------------------------------ |
| **상호 배제(Mutual exclution)** | 자원은 한 번에 한 프로세스만이 사용할 수 있어야 한다.        |
| **점유 대기(Hold and wait)**    | 최소한 하나의 자원을 점유하고 있으면서, 다른 프로세스에 할당되어 사용하고 있는 자원을 추가로 점유하기 위해 대기하는 프로세스가 있어야 한다. |
| **비선점(No preemption)**       | 다른 프로세스에 할당된 자원은 사용이 끝날 때까지 강제로 빼앗을 수 없어야 한다. |
| **순환 대기(Circular wait)**    | 대기 프로세스의 집합이 순환 형태로 자원을 대기하고 있어야 한다. |

</br>

### 데드락(Dead lock)의 해결법

#### 1. 예방 기법(Prevention)

교착 상태 발생 조건 중 하나를 제거함으로써 해결하는 방법. 자원의 낭비가 심함.

- **상호 배제 부정** : 여러 개의 프로세스가 공유 자원을 사용할 수 있도록 한다.

- **점유 대기 부정** : 프로세스가 실행되기 전 필요한 모든 자원을 할당한다.

- **비선점 부정** : 자원을 점유하고 있는 프로세스가 다른 자원을 요구할 때 점유하고 있는 자원을 반납하고, 요구한 자원을 사용하기 위해 기다리게 한다.

- **순환 대기 부정** : 자원에 고유한 번호를 할당하고, 번호 순서대로 자원을 요구하도록 한다.

</br>

#### 2. 회피 기법(Avoidance)

교착 상태의 가능성을 미리 조사하여 교착 상태 발생을 피해나가는 방법. 시스템의 프로세스들이 요청하는 모든 자원을, 데드락을 발생시키지 않으면서도 차례로 모두에게 할당해 줄 수 있는 상태를 **안정 상태(safe state)**라고 한다. 회피는 데드락 발생 가능성이 있는 불안정 상태가 아닌 <u>안정 상태를 유지할 수 있도록 할당을 허용하는 것</u>이 기본 특징이다.

`교착상태는 불안정상태에 속한다. (불안정 상태가 더 큰 개념)`

- **은행원 알고리즘(Banker's Algorithm)**

  - 미리 결정된 모든 자원들의 최대 가능한 할당량을 가지고 시뮬레이션해서 Safe state에 들 수 있는지 여부를 검사.
  - Safe state에 있으면 자원을 할당하고, 그렇지 않으면 다른 프로세스들이 자원을 해지할 때까지 대기
  - 자원 할당량을 사전에 파악하고 데드락을 회피할 수 있다.
  - 프로세스의 모든 요구를 유한한 시간안에 할당하는 것을 보장

  ![image](https://user-images.githubusercontent.com/41420639/111907048-f9773a00-8a96-11eb-9532-bdd144da222e.png)

  - 단점 : 제약 조건이 많음.
    - 할당할 수 있는 자원의 수가 일정해야 한다.
    - 사용자 수가 일정해야 한다.
    - 최대 자원 요구량을 미리 알아야한다.
    - 항상 불안정 상태를 방지해야 하므로 자원 이용도가 낮음.
    - 프로세스들은 유한한 시간 안에 자원을 반납해야 한다.

</br>

#### 3. 탐지 기법(Detection)

시스템에 교착상태가 발생했는지 점검하여 교착 상태에 있는 프로세스와 자원을 발견하는 방법.

- **자원 할당 그래프(Resource-Allocation-Graph)**

  - 프로세스와 자원의 요청 및 할당 관계를 표시한 그래프
  - 순환 대기 조건을 발견하기 위한 목적으로 사용

  ![img](https://t1.daumcdn.net/cfile/tistory/2531613555FAC00F11)

  - 데드락인 경우 : 싸이클 내의 공유 자원들이 모두 싸이클을 형성하고 있는 프로세스들에 의해 점유되고 있는 경우.
  - 데드락이 아닌 경우 : 싸이클을 형성하고 있지 않거나, 형성하고 있지만 공유 자원의 인스턴스들을 싸이클을 형성하는 프로세스 외에 다른 프로세스들도 점유하고 있는 경우. (싸이클 외 프로세스들이 lock을 풀면 다른 프로세스가 자원을 사용할 수 있기 때문)
  - 단점 : 자원을 요청할 때마다 탐지 알고리즘을 실행하면 오버헤드 발생

</br>

#### 4. 회복 기법(Recovery)

교착 상태를 일으킨 프로세스를 종료하거나 교착 상태의 프로세스에 할당된 자원을 선점하여 프로세스나 자원을 회복하는 방법.

- **프로세스 종료**
  - 교착 상태에 있는 프로세스를 종료. 
  - 교착 상태에 있는 모든 프로세스를 종료하는 방법과, 
  - 교착 상태에 있는 프로세스들을 하나씩 종료해가며 교착상태를 해결하는 방법이 있음
- **자원 선점**
  - 교착 상태의 프로세스가 점유하고 있는 자원을 선점하여 다른 프로세스에게 할당하며, 해당 프로세스를 일시 정지시키는 방법. 
  - 우선순위가 낮은 프로세스, 수행된 정도가 적은 프로세스, 사용되는 자원이 적은 프로세스 등을 위주로 해당 프로세스의 자원을 선점.
  - 고려 사항
    - 자원 을 선점할 프로세스 선택 문제 : 최소의 피해를 줄 수 있는 프로세스를 선택합니다.
    - 자원을 선점한 프로세스의 복귀 문제 : 자원이 부족한 상태이므로 대부분 일시 중지시키고 다시 시작하는 방법을 사용.
    - 기아 현상 문제 : 한 프로세스가 계속하여 자원 선점 대상이 되지 못하도록 고려.

</br>

#### [참고]

> - https://includestdio.tistory.com/12
> - https://chanhuiseok.github.io/posts/cs-2/
> - https://coding-factory.tistory.com/311
> - https://jhnyang.tistory.com/102
> - https://wannabe-gosu.tistory.com/26
> - https://developerhenrycho.tistory.com/20